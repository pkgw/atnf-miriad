#-----------------------------------------------------------------------------
# GNUmakefile for compiling the Miriad user guide.
#
# Original: 2006/09/25, Mark Calabretta, ATNF
# $Id$
#-----------------------------------------------------------------------------
# Get common makefile variables and rules.
include $(MIR)/GNUmakedefs

ifeq "$(MAKEMODE)" "system"
  # System-oriented rules.
  #-----------------------
  MIRFIGS  := $(filter %.fig,$(MIRSRCS))
  MIRGS    := $(filter %.g,$(MIRSRCS))
  MIRINCS  := $(filter %.inc,$(MIRSRCS))

  # The temporary area must be on the same filesystem as $(USRHTMLD).
  USRHTMLD := $(MIRHTMLD)/userguide
  TMPHTMLD := $(MIRHTMLD)/userguide_tmp
  DATE     := $(shell date +"%d %h %Y")

  show ::
	-@ echo ""
	-@ echo ""
	-@ echo "Variables defined in the userguide GNUmakefile"
	-@ echo "=============================================="
	-@ echo ""
	-@ echo "MIRFIGS  = $(MIRFIGS)"
	-@ echo "MIRGS    = $(MIRGS)"
	-@ echo "MIRINCS  = $(MIRINCS)"
	-@ echo ""
	-@ echo "USRHTMLD = $(USRHTMLD)"
	-@ echo "TMPHTMLD = $(TMPHTMLD)"
	-@ echo ""
	-@ echo "DATE     = $(DATE)"

  # Pattern rules.
  #---------------
  %.ps : %.fig
	   $(FIG2DEV) -L ps -p dummy_arg $< $@

  %.ps : %.g
	   $(GNUPLOT) $<


  # Static and static pattern rules.
  #---------------------------------
  allsys :: $(MIRROOT)/userguide.ps $(MIRROOT)/userguide_US.ps.gz \
    $(USRHTMLD)/userhtml.html $(MIRGUIDD)/taskref.txt

  # Make the PostScript depend only on the source files so we won't have to
  # retain any intermediaries.
  $(MIRROOT)/userguide.ps $(MIRROOT)/userguide_US.ps.gz : userguide.tex \
    Buildtitlepage $(MIRINCS) $(MIRFIGS) $(MIRGS)
	 @ Buildtitlepage User
	 @ for FIG in $(basename $(MIRFIGS)) ; do \
	     $(FIG2DEV) -L ps -p dummy_arg $$FIG.fig $$FIG.ps ; \
	   done
	 @ for G in $(MIRGS) ; do \
	     $(GNUPLOT) $$G ; \
	   done
	-@ echo ""
	   $(LATEX) $< > /dev/null
	   $(LATEX) $< > /dev/null
	-@ echo ""
	   $(MAKEINDEX) userguide
	-@ echo ""
	   $(LATEX) $<
	-@ $(RM) userguide.ind userguide.idx userguide.ilg
	-@ $(RM) userguide.aux userguide.log userguide.lot userguide.toc
	-@ echo ""
	   $(DVIPS) -D 600 -Z -o userguide.ps userguide.dvi
	-@ chmod 644 userguide.ps
	-@ $(RM) $(MIRROOT)/userguide.ps
	   mv userguide.ps $(MIRROOT)/
	-@ echo ""
	   $(DVIPS) -D 600 -Z -tletter -y940 -o userguide_US.ps userguide.dvi
	-@ $(RM) userguide.dvi titlepage.eps
	-@ $(RM) $(MIRFIGS:%.fig=%.ps) $(MIRGS:%.g=%.ps)
	   $(GZIP) -f userguide_US.ps
	-@ chmod 644 userguide_US.ps.gz
	-@ $(RM) $(MIRROOT)/userguide_US.ps.gz
	   mv userguide_US.ps.gz $(MIRROOT)/

  $(USRHTMLD)/userhtml.html : userhtml.tex $(MIRINCS) $(MIRFIGS) $(MIRGS)
	 @ for FIG in $(basename $(MIRFIGS)) ; do \
	     $(FIG2DEV) -L ps -p dummy_arg $$FIG.fig $$FIG.ps ; \
	   done
	 @ for G in $(MIRGS) ; do \
	     $(GNUPLOT) $$G ; \
	   done
	-@ echo ""
	   $(LATEX) $< > /dev/null
	   $(LATEX) $<
	-@ echo ""
	-@ $(RM) -r $(TMPHTMLD)
	 @ mkdir -m2775 -p $(TMPHTMLD)
	   latex2html -init_file ./dot.latex2html-init -info 0 \
	     -t "Miriad User Guide" \
	     -address "Last generated by miriad@atnf.csiro.au on $(DATE)" \
	     -dir $(TMPHTMLD) userhtml.tex
	 @ if [ $$? = 0 ] ; then \
	     $(RM) -r $(USRHTMLD) ; \
	     mv $(TMPHTMLD) $(USRHTMLD) ; \
	   fi
	-@ $(RM) $(MIRFIGS:%.fig=%.ps) $(MIRGS:%.g=%.ps)
	-@ $(RM) userhtml.aux userhtml.dvi userhtml.log 

  # taskref.txt lists all references to Miriad tasks in the userguide.
  $(MIRGUIDD)/taskref.txt : $(USRHTMLD)/userhtml.html
	   cd $(USRHTMLD) ; $(MIRGUIDD)/user/TaskRef.pl > $(MIRTMPD)/$(@F)
	-@ if [ $$? = 0 ] ; then \
	     $(RM) $(@F) ; \
	     mv -f $(MIRTMPD)/$(@F) $@ ; \
	   fi

  cleansys ::
	   $(RM) titlepage.eps $(MIRFIGS:%.fig=%.ps) $(MIRGS:%.g=%.ps)
	   $(RM) *.aux *.dvi *.idx *.ilg *.ind *.log *.lot *.toc
	   $(RM) junk.*

  help ::
	-@ echo ""
	-@ echo "Targets defined in the userguide GNUmakefile"
	-@ echo "--------------------------------------------"
	-@ echo "     allsys: compile userguide, PostScript and HTML."

else
  # Programmer-oriented rules.
  #---------------------------
  help ::
	-@ echo ""
	-@ echo "No programmer-oriented rules are defined in the userguide"
	-@ echo "GNUmakefile."
endif
