#-----------------------------------------------------------------------------
# GNUmakefile for compiling the Miriad programmer guide.
#
# Original: 2006/09/25, Mark Calabretta, ATNF
# $Id$
#-----------------------------------------------------------------------------
# Get common makefile variables and rules.
include $(MIR)/GNUmakedefs

ifeq "$(MAKEMODE)" "system"
  # System-oriented rules.
  #-----------------------
  MIRINCS  := $(filter %.inc,$(MIRSRCS))

  # The temporary area must be on the same filesystem as $(MIRHTMLD).
  PRGHTMLD := $(MIRHTMLD)/progguide
  TMPHTMLD := $(MIRHTMLD)/progguide_tmp
  DATE     := $(shell date +"%d %h %Y")

  show ::
	-@ echo ""
	-@ echo ""
	-@ echo "Variables defined in the progguide GNUmakefile"
	-@ echo "=============================================="
	-@ echo ""
	-@ echo "MIRINCS  = $(MIRINCS)"
	-@ echo ""
	-@ echo "PRGHTMLD = $(PRGHTMLD)"
	-@ echo "TMPHTMLD = $(TMPHTMLD)"
	-@ echo ""
	-@ echo "DATE     = $(DATE)"


  # Static and static pattern rules.
  #---------------------------------
  allsys :: progguide.ps progguide_US.ps.gz $(PRGHTMLD)/progguide.html

  # It takes two passes through latex to resolve cross-references, these runs
  # are quiet.  Inclusion of the \makeindex command in the preamble of the
  # LaTeX source causes latex to write a .idx file containing information
  # compiled from \index commands.  makeindex generates a .ind file from .idx,
  # and in the final run latex uses this to print the index via \printindex.
  #
  # latex2html requires intermediate files generated by latex so it's more
  # efficient to generate the HTML manual in combination with the PostScript
  # document in one combined rule.  
  progguide.ps progguide_US.ps.gz $(PRGHTMLD)/progguide.html : progguide.tex \
    Buildtitlepage $(MIRINCS)
	 @ Buildtitlepage Programmer
	-@ echo ""
	-@ $(RM) defs.inc
	   ln -s latexdefs.inc defs.inc
	   $(LATEX) $< > /dev/null
	   $(LATEX) $< > /dev/null
	-@ echo ""
	   $(MAKEINDEX) progguide
	-@ echo ""
	   $(LATEX) $<
	-@ $(RM) progguide.ind progguide.idx progguide.ilg
	-@ echo ""
	   $(DVIPS) -D 600 -Z -o progguide.ps progguide.dvi
	-@ echo ""
	   $(DVIPS) -D 600 -Z -tletter -y940 -o progguide_US.ps progguide.dvi
	-@ $(RM) progguide.dvi titlepage.eps
	   $(GZIP) -f progguide_US.ps
	-@ echo ""
	-@ $(RM) -r $(TMPHTMLD)
	-@ mkdir -m2775 -p $(TMPHTMLD)
	-@ $(RM) defs.inc
	   ln -s htmldefs.inc defs.inc
	   latex2html -init_file dot.latex2html-init -info 0 \
	     -t "Miriad Programmer Guide" \
	     -address "Last generated by miriad@atnf.csiro.au on $(DATE)" \
	     -dir $(TMPHTMLD) progguide.tex
	 @ if [ $$? = 0 ] ; then \
	     $(RM) -r $(PRGHTMLD) ; \
	     mv $(TMPHTMLD) $(PRGHTMLD) ; \
	   fi
	-@ $(RM) defs.inc
	-@ $(RM) progguide.aux progguide.log progguide.lot progguide.toc

  cleansys ::
	   $(RM) defs.inc titlepage.eps
	   $(RM) *.aux *.dvi *.idx *.ilg *.ind *.log *.lot *.toc

  help ::
	-@ echo ""
	-@ echo "Targets defined in the progguide GNUmakefile"
	-@ echo "--------------------------------------------"
	-@ echo "     allsys: compile progguide, PostScript and HTML."

else
  # Programmer-oriented rules.
  #---------------------------
  help ::
	-@ echo ""
	-@ echo "No programmer-oriented rules are defined in the progguide"
	-@ echo "GNUmakefile."
endif
